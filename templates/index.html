<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- 引入 layui.css -->
        <link rel="stylesheet" href="//unpkg.com/layui@2.6.8/dist/css/layui.css" />

        <!-- 引入 layui.js -->
        <script src="//unpkg.com/layui@2.6.8/dist/layui.js"></script>
        <style>
          body{margin: 10px;}
          .demo-carousel{height: 200px; line-height: 200px; text-align: center;}
        </style>
        <title>download</title>
        <style>
            .s1 {
                border-style: solid;
                border-color: #ACD6FF;
                border-width: 0.1em;
                padding: 0.2em;
                margin: 0.2em;
            }
    
            body {
                font: normal 90% Helvetica, Arial, sans-serif;
            }
        </style>
        <script  type="text/javascript"  src="http://code.jquery.com/jquery-latest.js"></script>
        <script>
            'use strict';
            function addName() {
                $.post("/addName", { 'name' : $("#name").val() },
                (data) => {
                    if (data !== "") {
                        $('#nameList').append($('<option>', {value : data, text : data}));
                    }
                });
            }
            function delName() {
                $.post("/delName", { 'name' : $("#nameList option:selected").text() },
                (data) => {
                    $("#nameList").find("option:selected").remove();
                });
            }
            function download() {
                $.post("/download", {
                    'name' : $("#nameList option:selected").text(),
                    'videoUrl' : $("#video-address").val()
                }, (data) => { alert("启动成功"); }
                );
            }
            function renderSize(value){
                if(null==value||value==''){
                    return "0 Bytes";
                }
                var unitArr = new Array("Bytes","KB","MB","GB","TB","PB","EB","ZB","YB");
                var index=0;
                var srcsize = parseFloat(value);
                index=Math.floor(Math.log(srcsize)/Math.log(1024));
                var size =srcsize/Math.pow(1024,index);
                size=size.toFixed(2);//保留的小数位数
                return size+unitArr[index];
            }
            function fresh() {
                $.get("/watch",
                    (data) => {
                        console.log(data);
                        $("#freshTime").html(Date());
                        var tbody = $("#watchBody")
                        tbody.empty();
                        JSON.parse(data).forEach(function(value){
                            var tr = $("<tr></tr>");
                            tr.append($("<td>" + value['name'] + "</td>"));
                            if (value['state']) {
                                tr.append($("<td>" + value['state'] + "</td>"));
                            } else {
                                tr.append($("<td style=\"background-color:red\">" + value['state'] + "</td>"));
                            }
                            tr.append($("<td>" + renderSize(value['totalSize']) + "</td>"));
                            tr.append($("<td>" + value['totalFileNum'] + "</td>"));
                            tr.append($("<td>" + renderSize(value['currentSize']) + "</td>"));
                            tr.append($('<td> <button onclick="deleteProcess(\'' + value['name'] +'\')" class="layui-btn">停止</button></td>'));
                            tr.appendTo(tbody);
                        });
                    }
                );
            }
            function deleteProcess(name) {
                $.post("/deleteProcess", { 'name' : name }, (data) => { fresh(); });
            }
            function selectChange(name) {
                $("#video-address").val("");
            }
        </script>
    </head>
    <body>
        <div id="dir" class="layui-form-item">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
                <legend>名称配置</legend>
            </fieldset>
            <label class="layui-form-label">新增名称：</label>
            <div class="layui-input-inline">
                <input placeholder="请输入新增名称" type="tel" name="name" id="name" lay-verify="required|phone" autocomplete="off" class="layui-input">
            </div>
            <button id="addName" onclick="addName()" class="layui-btn">添加</button>
        </div>
        <div class="layui-form-item">
            <p>
                <label class="layui-form-label">选择名称：</label>
                <div class="layui-input-inline">
                    <select id="nameList" lay-verify="required" lay-search="" onchange="selectChange()">
                        <option value="">直接选择或搜索选择</option>
                        {% for i in anchorList %}
                            <option value={{ i }}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button onclick="download()" class="layui-btn">开始下载</button>
                <button id="delName" onclick="delName()" class="layui-btn">删除名称</button>
            </p>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">输入网站：</label>
            <div class="layui-input-block">
                <textarea placeholder="请输入网站" id="video-address" class="layui-textarea"></textarea>
              </div>
            <button id="startDownLoad" onclick="download()" class="layui-btn">开始下载</button>
        </div>
        <div id="dir1" class="layui-form-item">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
                <legend>状态监控</legend>
            </fieldset>
            <p><button id="fresh" onclick="fresh()" class="layui-btn">刷新</button></p>
            <p><label class="layui-form-label" id="freshTime" style="width: 400px;"></label></p>
            <table class="layui-table">
                <colgroup>
                  <col width="150">
                  <col width="200">
                  <col>
                </colgroup>
                <thead>
                  <tr>
                    <th>名称</th>
                    <th>进程状态</th>
                    <th>写入文件大小</th>
                    <th>写入文件个数</th>
                    <th>缓冲区大小</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id = "watchBody">
                </tbody>
              </table>
        </div>
    </body>
</html>